<!-- هذا الملف يمثل بطاقة عرض الهودي بتطبيق هيكلية المجلدات الجديدة: IMGES/BLACK و IMGES/WHITE و IMGES/GIRLS -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanVerse - متجر المنتجات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .active-filter {
            background-color: #DC2626 !important; /* red-600 */
            color: white !important;
            border-color: #DC2626 !important;
        }
        /* Styling for the slideshow */
        .slide {
            height: 100%;
            background-size: cover;
            background-position: center;
            display: none;
            transition: opacity 0.5s ease-in-out;
            position: relative;
        }
        .slide.active {
            display: block;
        }
        /* Custom styling for color dots */
        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .color-dot.active {
            transform: scale(1.2);
            border-color: #DC2626; /* Red border for active dot */
        }
        /* Modal navigation arrows styling */
        .modal-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(220, 38, 38, 0.7); /* red-600 with transparency */
            color: white;
            font-size: 2rem;
            width: 40px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            user-select: none;
            transition: background-color 0.2s;
        }
        .modal-arrow:hover {
            background-color: rgba(220, 38, 38, 1);
        }
        #prevImage {
            right: 0; /* Arrow on the right in RTL (moves to PREVIOUS CARD) */
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        #nextImage {
            left: 0; /* Arrow on the left in RTL (moves to NEXT CARD) */
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }
        /* Ensure image container is relative for arrows */
        #imageModalContent {
            position: relative;
        }
        /* New CSS for clearer scaled images */
        .product-image {
            /* Force GPU acceleration for sharper resizing */
            transform: translateZ(0); 
            /* Ensure maximum clarity for scaled images */
            image-rendering: -webkit-optimize-contrast; 
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" class="flex items-center gap-3">
                <!-- SVG Logo -->
                <svg class="h-12 w-12 sm:h-14 sm:w-14" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="48" fill="white"/>
                    <circle cx="50" cy="50" r="48" fill="none" stroke="#DC2626" stroke-width="3"/>
                    <circle cx="50" cy="50" r="42" fill="none" stroke="#DC2626" stroke-width="1"/>
                    <text x="50" y="55" font-family="Cairo, sans-serif" font-size="20" font-weight="800" fill="black" text-anchor="middle">FANVERSE</text>
                    <path d="M 35 25 L 50 25 L 50 40 L 45 40 L 45 30 L 35 30 Z" fill="#DC2626"/>
                    <path d="M 50 25 L 65 25 L 55 40 Z" fill="#DC2626"/>
                    <path d="M 42 60 L 58 60 L 50 75 Z" fill="#DC2626"/>
                </svg>
                <span class="text-2xl sm:text-3xl font-extrabold text-gray-800 dark:text-white tracking-tight">FanVerse</span>
            </a>
            <nav>
                <!-- Category filter buttons will be rendered here by JS (Now excluding 'الكل') -->
                <div id="category-filters" class="flex gap-2 flex-wrap justify-center"></div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-10">

        <!-- Slideshow (Hero Section) -->
        <section id="hero-slideshow" class="mb-12 rounded-xl overflow-hidden shadow-2xl relative w-full h-64 md:h-96 bg-white dark:bg-gray-700" data-autoplay-interval="4000">
            <div id="slides-container" class="h-full relative overflow-hidden">
                <!-- Slides will be injected here by JS -->
            </div>
            <!-- Slide Dots Indicator -->
            <div id="slideshow-dots" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
                <!-- Dots will be injected here by JS -->
            </div>
        </section>

        <!-- Products Section -->
        <section id="products">
            <h2 class="text-3xl font-bold text-center mb-8 text-gray-900 dark:text-white">منتجاتنا</h2>
            
            <!-- GENDER FILTERS CONTAINER - Hidden by default, appears only when 'هودي' is selected -->
            <div id="gender-filters" class="flex justify-center gap-4 mb-8" style="display: none;">
                <!-- Buttons will be rendered here by JS -->
            </div>
            <!-- END GENDER FILTERS CONTAINER -->

            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                <!-- Product cards will be displayed here -->
            </div>
        </section>

        <!-- About Us Section -->
        <section id="about" class="mt-20 bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl">
            <h2 class="text-3xl font-bold text-center mb-6 text-red-600 dark:text-red-500"> FanVerse </h2>
            <p class="text-center max-w-3xl mx-auto mb-8 text-gray-600 dark:text-gray-300">
                FanVerse مش مجرد براند، دي مساحة تعبر بيها عن نفسك.
من هدوم شيك لحد أكسسوار يومي، كل قطعة معمولة عشان تديك ستايل يخصك أنت.
            </p>
            
            <div class="grid md:grid-cols-3 gap-8 text-center max-w-5xl mx-auto">
                <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border-t-4 border-red-500">
                    <h3 class="text-xl font-bold mb-3">الإبداع</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400"> كل تصميم معمول بروح جديدة عشان يخلي ستايلك مختلف.</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border-t-4 border-red-500">
                    <h3 class="text-xl font-bold mb-3">الجودة</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">خامات قوية ومعايير عالية تديك راحة وعُمر أطول.</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border-t-4 border-red-500">
                    <h3 class="text-xl font-bold mb-3">التنوع</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">مجموعتنا واسعة، تلاقي فيها اللي يعبر عنك أيًّا كان ذوقك.</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 dark:bg-black mt-16 py-6">
        <div class="container mx-auto px-6 text-center text-gray-400 dark:text-gray-500">
            <p>&copy; 2025 FanVerse. كل الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div id="imageModalContent" class="relative bg-white dark:bg-gray-800 p-4 rounded-lg max-w-3xl max-h-full shadow-2xl">
            <button id="closeModal" class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center text-xl font-bold z-10 leading-none">&times;</button>
            <img id="modalImage" src="" alt="عرض مكبر للمنتج" class="max-w-full max-h-[85vh] object-contain rounded-md">

            <!-- Modal Navigation Arrows -->
            <div id="prevImage" class="modal-arrow" style="border-radius: 0.5rem 0 0 0.5rem;">&#x276F;</div> <!-- Right arrow (Prev in RTL layout) -->
            <div id="nextImage" class="modal-arrow" style="border-radius: 0 0.5rem 0.5rem 0;">&#x276E;</div> <!-- Left arrow (Next in RTL layout) -->
            
            <!-- Metadata (stores info about the current image) -->
            <div id="modalMetadata" data-is-two-color="false" data-card-index="-1" data-current-color="black" data-filtered-indices="[]" class="hidden"></div>
        </div>
    </div>


    <script>
        // Function to generate a placeholder image URL
        const generatePlaceholder = (text, color = 'black', width = 600, height = 600) => {
            const bgColor = color === 'white' ? 'FFFFFF' : '000000';
            const textColor = color === 'white' ? '000000' : 'FFFFFF';
            // Placeholder URL, using the file path as the text if the file is missing
            return `https://placehold.co/${width}x${height}/${bgColor}/${textColor}?text=MISSING+IMAGE%3A+${encodeURIComponent(text.trim())}`;
        }

        // --- Slideshow Configuration ---
        const SLIDESHOW_IMAGES = [
            'IMGES/ad_1.png', 
            'IMGES/ad_2.png', 
            'IMGES/ad_3.png', 
        ];
        
        // --- Product Data ---
        
        // **مصفوفة المنتجات (60 هودي أصلي بدون gender + 3 GIRLS + 19 مج + 2 قريباً = 84 بطاقة):**
        const products = [
            // ===========================================
            // 1. بطاقات الهودي الأصلية (لا يوجد خاصية gender)
            // ===========================================
            {
                name: 'هودي space 1', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/2.png',
                whiteImageUrl: 'IMGES/WHITE/2.png', 
            },
            {
                name: 'هودي space 2', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/23.png',
                whiteImageUrl: 'IMGES/WHITE/23.png', 
            },
            {
                name: 'هودي RABBIT', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/1.png',
                whiteImageUrl: 'IMGES/WHITE/1.png',
            },
            {
                name: 'هودي GOOD VIBES', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/36.png',
                whiteImageUrl: 'IMGES/WHITE/36.png',
            },

            {
                name: 'هودي cyborg samurai', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/3.png',
                whiteImageUrl: 'IMGES/WHITE/3.png',
            },
            {
                name: 'هودي RAVEN', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/8.png',
                whiteImageUrl: 'IMGES/WHITE/8.png',
            },
            {
                name: 'هودي YOU', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/5.png',
                whiteImageUrl: 'IMGES/WHITE/5.png',
            },
            {
                name: 'هودي OUT OF BOX', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/6.png',
                whiteImageUrl: 'IMGES/WHITE/6.png',
            },
            {
                name: 'هودي Black Clover', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/7.png',
                whiteImageUrl: 'IMGES/WHITE/7.png',
            },
            {
                name: 'هودي samurai', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/9.png',
                whiteImageUrl: 'IMGES/WHITE/9.png',
            },
            {
                name: 'هودي ANGEL', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/10.png',
                whiteImageUrl: 'IMGES/WHITE/10.png',
            },
            {
                name: 'هودي Yuji Itadori', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/4.png',
                whiteImageUrl: 'IMGES/WHITE/4.png',
            },
            {
                name: 'هودي breaking bad', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/11.png',
                whiteImageUrl: 'IMGES/WHITE/11.png',
            },
            {
                name: 'هودي ZORO', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/12.png',
                whiteImageUrl: 'IMGES/WHITE/12.png',
            },
            
            {
                name: 'هودي Pharaon', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/31.png',
                whiteImageUrl: 'IMGES/WHITE/24.png',
            },

            {
                name: 'هودي LOFY', category: 'هودي', price: '650 L.E', isTwoColor: true, 
                blackImageUrl: 'IMGES/BLACK/16.png',
                whiteImageUrl: 'IMGES/WHITE/16.png',
            },
            
            // 2. البطاقات الإضافية للهودي (32 بطاقة) - الأصلية
            { name: 'هودي تصميم رقم 17', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/17.png', whiteImageUrl: 'IMGES/WHITE/17.png' }, 
            { name: 'هودي تصميم رقم 18', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/18.png', whiteImageUrl: 'IMGES/WHITE/18.png' }, 
            { name: 'هودي تصميم رقم 19', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/19.png', whiteImageUrl: 'IMGES/WHITE/19.png' }, 
            { name: 'هودي تصميم رقم 20', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/20.png', whiteImageUrl: 'IMGES/WHITE/20.png' }, 
            { name: 'هودي تصميم رقم 21', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/21.png', whiteImageUrl: 'IMGES/WHITE/21.png' }, 
            { name: 'هودي تصميم رقم 22', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/22.png', whiteImageUrl: 'IMGES/WHITE/22.png' }, 
            { name: 'هودي تصميم رقم 23', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/23.png', whiteImageUrl: 'IMGES/WHITE/23.png' }, 
            { name: 'هودي تصميم رقم 24', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/24.png', whiteImageUrl: 'IMGES/WHITE/24.png' }, 
            { name: 'هودي تصميم رقم 25', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/25.png', whiteImageUrl: 'IMGES/WHITE/25.png' }, 
            { name: 'هودي تصميم رقم 26', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/26.png', whiteImageUrl: 'IMGES/WHITE/26.png' }, 
            { name: 'هودي تصميم رقم 27', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/27.png', whiteImageUrl: 'IMGES/WHITE/27.png' }, 
            { name: 'هودي تصميم رقم 28', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/28.png', whiteImageUrl: 'IMGES/WHITE/28.png' }, 
            { name: 'هودي تصميم رقم 29', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/29.png', whiteImageUrl: 'IMGES/WHITE/29.png' }, 
            { name: 'هودي تصميم رقم 30', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/30.png', whiteImageUrl: 'IMGES/WHITE/30.png' }, 
            { name: 'هودي تصميم رقم 31', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/31.png', whiteImageUrl: 'IMGES/WHITE/31.png' }, 
            { name: 'هودي تصميم رقم 32', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/32.png', whiteImageUrl: 'IMGES/WHITE/32.png' }, 
            { name: 'هودي تصميم رقم 33', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/33.png', whiteImageUrl: 'IMGES/WHITE/33.png' }, 
            { name: 'هودي تصميم رقم 34', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/34.png', whiteImageUrl: 'IMGES/WHITE/34.png' }, 
            { name: 'هودي تصميم رقم 35', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/35.png', whiteImageUrl: 'IMGES/WHITE/35.png' }, 
            { name: 'هودي تصميم رقم 36', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/36.png', whiteImageUrl: 'IMGES/WHITE/36.png' }, 
            { name: 'هودي تصميم رقم 37', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/37.png', whiteImageUrl: 'IMGES/WHITE/37.png' }, 
            { name: 'هودي تصميم رقم 38', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/38.png', whiteImageUrl: 'IMGES/WHITE/38.png' }, 
            { name: 'هودي تصميم رقم 39', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/39.png', whiteImageUrl: 'IMGES/WHITE/39.png' }, 
            { name: 'هودي تصميم رقم 40', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/40.png', whiteImageUrl: 'IMGES/WHITE/40.png' }, 
            { name: 'هودي تصميم رقم 41', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/41.png', whiteImageUrl: 'IMGES/WHITE/41.png' }, 
            { name: 'هودي تصميم رقم 42', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/42.png', whiteImageUrl: 'IMGES/WHITE/42.png' }, 
            { name: 'هودي تصميم رقم 43', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/43.png', whiteImageUrl: 'IMGES/WHITE/43.png' }, 
            { name: 'هودي تصميم رقم 44', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/44.png', whiteImageUrl: 'IMGES/WHITE/44.png' }, 
            { name: 'هودي تصميم رقم 45', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/45.png', whiteImageUrl: 'IMGES/WHITE/45.png' }, 
            { name: 'هودي تصميم رقم 46', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/46.png', whiteImageUrl: 'IMGES/WHITE/46.png' }, 
            { name: 'هودي تصميم رقم 47', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/47.png', whiteImageUrl: 'IMGES/WHITE/47.png' }, 
            { name: 'هودي تصميم رقم 48', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/48.png', whiteImageUrl: 'IMGES/WHITE/48.png' }, 
            
            { name: 'هودي تصميم رقم 50', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/50.png', whiteImageUrl: 'IMGES/WHITE/50.png' }, 
            { name: 'هودي تصميم رقم 60', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/51.png', whiteImageUrl: 'IMGES/WHITE/51.png' }, 
            { name: 'هودي تصميم رقم 61', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/52.png', whiteImageUrl: 'IMGES/WHITE/52.png' }, 

            { name: 'هودي تصميم رقم 62', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/53.png', whiteImageUrl: 'IMGES/WHITE/53.png' }, 

            { name: 'هودي تصميم رقم 63', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/54.png', whiteImageUrl: 'IMGES/WHITE/54.png' }, 
            { name: 'هودي تصميم رقم 64', category: 'هودي', price: '650 L.E', isTwoColor: true, blackImageUrl: 'IMGES/BLACK/55.png', whiteImageUrl: 'IMGES/WHITE/55.png' }, 
            
            // ===========================================
            // 3. بطاقات الهودي الجديدة (GIRLS) - 3 CARDS ADDED HERE
            // تم تحديد خاصية gender: 'GIRLS'
            // ===========================================
            { 
                name: 'هودي (GIRL) تصميم 1', category: 'هودي', price: '650 L.E', isTwoColor: true, gender: 'GIRLS', 
                blackImageUrl: 'IMGES/GIRLS/1.png', 
                whiteImageUrl: 'IMGES/GIRLS/h(2).png' 
            },
            { 
                name: 'هودي (GIRL) تصميم 2', category: 'هودي', price: '650 L.E', isTwoColor: true, gender: 'GIRLS', 
                blackImageUrl: 'IMGES/GIRLS/2.png', 
                whiteImageUrl: 'IMGES/GIRLS/3.png' 
            },
            { 
                name: 'هودي (GIRL) تصميم 3', category: 'هودي', price: '650 L.E', isTwoColor: true, gender: 'GIRLS', 
                blackImageUrl: 'IMGES/GIRLS/4.png', 
                whiteImageUrl: 'IMGES/GIRLS/.png' 
            },
            { 
                name: 'هودي (GIRL) تصميم 4', category: 'هودي', price: '650 L.E', isTwoColor: true, gender: 'GIRLS', 
                blackImageUrl: 'IMGES/GIRLS/5.png', 
                whiteImageUrl: 'IMGES/GIRLS/.png' 
            },
            { 
                name: 'هودي (GIRL) تصميم 5', category: 'هودي', price: '650 L.E', isTwoColor: true, gender: 'GIRLS', 
                blackImageUrl: 'IMGES/GIRLS/6.png', 
                whiteImageUrl: 'IMGES/GIRLS/.png' 
            },
            { 
                name: 'هودي (GIRL) تصميم 6', category: 'هودي', price: '650 L.E', isTwoColor: true, gender: 'GIRLS', 
                blackImageUrl: 'IMGES/GIRLS/7.png', 
                whiteImageUrl: 'IMGES/GIRLS/.png' 
            },
            { 
                name: 'هودي (GIRL) تصميم 7', category: 'هودي', price: '650 L.E', isTwoColor: true, gender: 'GIRLS', 
                blackImageUrl: 'IMGES/GIRLS/8.png', 
                whiteImageUrl: 'IMGES/GIRLS/.png' 
            },


            // ===========================================
            // 4. بطاقات المجات (19 بطاقة)
            // ===========================================
            
            { name: 'مج JOKER', category: 'مج', imageUrl: 'IMGES/M (1).png', price: '130 L.E' },
            { name: 'مج JOHN WICK', category: 'مج', imageUrl: 'IMGES/M (2).png', price: '130 L.E' },
            { name: 'مج FALASTIN', category: 'مج', imageUrl: 'IMGES/M (8).png', price: '130 L.E' },
            { name: 'مج ZORO', category: 'مج', imageUrl: 'IMGES/M (6).png', price: '130 L.E' },
            { name: 'مج DUCK', category: 'مج', imageUrl: 'IMGES/M (7).png', price: '130 L.E' },
            { name: 'مج ANGEL', category: 'مج', imageUrl: 'IMGES/M (9).png', price: '130 L.E' },
            { name: 'مج HARYY POTTER', category: 'مج', imageUrl: 'IMGES/M (4).png', price: '130 L.E' },
            { name: 'مج KRATOS', category: 'مج', imageUrl: 'IMGES/M (10).png', price: '130 L.E' },

            { name: 'مج تصميم رقم 11', category: 'مج', imageUrl: 'IMGES/M (11).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 12', category: 'مج', imageUrl: 'IMGES/M (12).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 13', category: 'مج', imageUrl: 'IMGES/M (13).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 14', category: 'مج', imageUrl: 'IMGES/M (14).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 15', category: 'مج', imageUrl: 'IMGES/M (15).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 16', category: 'مج', imageUrl: 'IMGES/M (16).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 17', category: 'مج', imageUrl: 'IMGES/M (17).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 18', category: 'مج', imageUrl: 'IMGES/M (18).png', price: '130 L.E' },
            { name: 'مج تصميم رقم 19', category: 'مج', imageUrl: 'IMGES/M (19).png', price: '130 L.E' },

            
            // ===========================================
            // 5. قريباً وأمثلة الاختبار (2 بطاقات)
            // ===========================================
            
            // Jacket & Tote Bag (2 قريباً)
            { name: 'Soon', category: 'جاكيت', price: '750 L.E' },
            { name: 'Soon', category: 'توتي باجز', price: '250 L.E' },
        ];

            // --- End of Product Data ---
        
        // --- Global Elements ---
        const productGrid = document.getElementById('product-grid');
        const categoryFiltersContainer = document.getElementById('category-filters');
        
        const genderFiltersContainer = document.getElementById('gender-filters');
        let activeGenderFilter = 'الكل'; 

        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');
        const prevImage = document.getElementById('prevImage');
        const nextImage = document.getElementById('nextImage');
        const modalMetadata = document.getElementById('modalMetadata');
        
        let activeFilter = 'هودي'; // Default filter
        
        // NEW: Array to hold references to the currently displayed *card elements*
        let currentlyDisplayedCards = []; 


        // --- Category Descriptions ---
        const categoryDescriptions = {
            'هودي': 'هودي قطن 100% بطباعة DTF عالية الجودة يعبر عن هويتك.',
            'مج': 'مج طباعة سبليمشن يعبر عن شغفك.',
            'توتي باجز': 'قريباً...', 
            'جاكيت': 'قريباً...',
        };


        // --- Slideshow Logic (MODIFIED) ---
        let currentSlideIndex = 0;
        let slideshowInterval;
        
        function renderSlideshow() {
            const container = document.getElementById('slides-container');
            const dotsContainer = document.getElementById('slideshow-dots');
            container.innerHTML = '';
            dotsContainer.innerHTML = '';

            SLIDESHOW_IMAGES.forEach((url, index) => {
                // 1. Create Slide Element (Removed the overlay and slide numbering span)
                const slide = document.createElement('div');
                slide.className = `slide absolute top-0 left-0 w-full h-full transition-opacity duration-1000 ${index === 0 ? 'active' : ''}`;
                
                // Only the image tag remains inside the slide for clean display
                slide.innerHTML = `<img src="${url}" alt="Slide ${index + 1}" class="w-full h-full object-fill">`;
                container.appendChild(slide);
                
                // If image fails to load, show a placeholder background
                const imgElement = slide.querySelector('img');
                imgElement.onerror = function() {
                    const errorText = `MISSING AD IMAGE: ${url.replace('IMGES/', '')}`;
                    // Changed object-contain to object-cover for background placeholder visibility
                    imgElement.className = 'w-full h-full object-cover';
                    imgElement.src = generatePlaceholder(errorText, 'black', 1200, 400);
                };
                
                // 2. Create Dot Indicator (Unchanged)
                const dot = document.createElement('span');
                dot.className = `w-3 h-3 bg-white opacity-50 rounded-full transition-opacity cursor-pointer ${index === 0 ? 'opacity-100' : ''}`;
                dot.onclick = () => showSlide(index);
                dotsContainer.appendChild(dot);
            });

            // Set up initial classes
            showSlide(0, false);
            setupSlideshowInteractions(container);
            startAutoplay();
        }

        function showSlide(index, transition = true) {
            const slides = document.querySelectorAll('#slides-container .slide');
            const dots = document.querySelectorAll('#slideshow-dots span');
            
            if (index >= slides.length) index = 0;
            if (index < 0) index = slides.length - 1;

            slides.forEach((slide, i) => {
                slide.classList.remove('active');
                slide.style.opacity = '0';
                if (!transition) {
                    slide.style.transition = 'none';
                }
            });

            dots.forEach(dot => dot.classList.remove('opacity-100'));

            slides[index].classList.add('active');
            // Force reflow before applying transition
            void slides[index].offsetWidth; 
            slides[index].style.transition = transition ? 'opacity 1s ease-in-out' : 'none';
            slides[index].style.opacity = '1';

            dots[index].classList.add('opacity-100');
            currentSlideIndex = index;
        }

        function nextSlide() {
            showSlide(currentSlideIndex + 1);
        }

        function prevSlide() {
            showSlide(currentSlideIndex - 1);
        }

        function startAutoplay() {
            clearInterval(slideshowInterval);
            const interval = parseInt(document.getElementById('hero-slideshow').dataset.autoplayInterval) || 4000;
            slideshowInterval = setInterval(nextSlide, interval);
        }
        
        function setupSlideshowInteractions(container) {
            let startX = 0;

            container.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                clearInterval(slideshowInterval);
            });

            container.addEventListener('mouseup', (e) => {
                const diffX = e.clientX - startX;
                if (diffX > 50) { // Swiped right (for RTL, this means previous)
                    prevSlide();
                } else if (diffX < -50) { // Swiped left (for RTL, this means next)
                    nextSlide();
                }
                startAutoplay();
            });

            // Touch events for mobile swiping
            container.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                clearInterval(slideshowInterval);
            });

            container.addEventListener('touchend', (e) => { 
                const endX = e.changedTouches[0].clientX;
                const diffX = endX - startX;
                if (Math.abs(diffX) > 40) { // Require a substantial swipe
                    if (diffX > 0) {
                        prevSlide();
                    } else {
                        nextSlide();
                    }
                }
                startAutoplay();
            });
        }
        
        // =================================================================
        //
        // --- HOODIE PRIORITY LOADING & COLOR TOGGLE FUNCTIONS ---
        //
        // =================================================================

        // دالة مساعدة للتحقق مما إذا كان المنتج يحتوي على صورة متاحة للعرض
        async function isProductImageAvailable(product) {
            if (!product) return false;
            if (product.isTwoColor) {
                // Hoodies: Check if black is available, then white
                const isBlackAvailable = await checkImageExists(product.blackImageUrl);
                if (isBlackAvailable) return true;
                const isWhiteAvailable = await checkImageExists(product.whiteImageUrl);
                return isWhiteAvailable;
            } else if (product.imageUrl) {
                // Mugs/Single items: Check single URL
                return await checkImageExists(product.imageUrl);
            }
            return false; // Coming Soon or no defined image
        }

        // دالة للتحقق من وجود الصورة عبر إنشاء كائن Image
        function checkImageExists(url) {
            return new Promise(resolve => {
                if (!url) {
                    resolve(false);
                    return;
                }
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // Function to handle the priority loading and display of the initial hoodie image (Black -> White -> Unavailable)
        function initializeHoodieCard(card) {
            const blackUrl = card.dataset.blackUrl;
            const whiteUrl = card.dataset.whiteUrl;
            const imgElement = card.querySelector('.product-image');
            const overlay = card.querySelector('.unavailable-overlay');
            const dotBlack = card.querySelector('.dot-black');
            const dotWhite = card.querySelector('.dot-white');

            // وظيفة مساعدة لتحديد اللون النشط
            const setActiveColor = (color) => {
                if (dotBlack) dotBlack.classList.remove('active');
                if (dotWhite) dotWhite.classList.remove('active');
                if (color === 'black' && dotBlack) dotBlack.classList.add('active');
                if (color === 'white' && dotWhite) dotWhite.classList.add('active');
                card.dataset.currentColor = color;
            };

            // وظيفة مساعدة لعرض خطأ (غير متاح)
            const showUnavailable = () => {
                if (overlay) {
                    imgElement.style.display = 'none';
                    overlay.classList.remove('hidden');
                } else {
                    const productName = card.querySelector('h3').textContent;
                    imgElement.src = generatePlaceholder(productName, 'black');
                    imgElement.style.display = 'block';
                }
                // عند الفشل، نظريًا لا يوجد لون نشط لكن نحافظ على حالته الافتراضية 'black'
                setActiveColor('black');
            };

            // 1. محاولة تحميل الصورة السوداء
            const tryLoadBlack = () => {
                const tempBlack = new Image();
                tempBlack.onload = () => {
                    imgElement.src = blackUrl;
                    setActiveColor('black');
                    if (overlay) overlay.classList.add('hidden');
                    imgElement.style.display = 'block';
                };
                tempBlack.onerror = () => {
                    // إذا فشل الأسود، ننتقل لمحاولة تحميل الأبيض
                    tryLoadWhite();
                };
                tempBlack.src = blackUrl;
            };

            // 2. محاولة تحميل الصورة البيضاء
            const tryLoadWhite = () => {
                const tempWhite = new Image();
                tempWhite.onload = () => {
                    imgElement.src = whiteUrl;
                    setActiveColor('white');
                    if (overlay) overlay.classList.add('hidden');
                    imgElement.style.display = 'block';
                };
                tempWhite.onerror = () => {
                    // إذا فشل الأبيض أيضًا، نظهر "غير متاح"
                    showUnavailable();
                };
                tempWhite.src = whiteUrl;
            };
            
            // البدء بمحاولة تحميل الأسود
            tryLoadBlack();

            // يجب التأكد من إزالة أي مستمعي onerror أو onload سابقين من عنصر الصورة الفعلي
            imgElement.onload = null;
            imgElement.onerror = null;

            // التأكد من إعداد مستمعي التفاعل (لأن المنطق أعلاه خاص بالتهيئة فقط)
            setupColorToggleInteractions(card);
        }

        // --- Modal Navigation Logic (MODIFIED TO USE filteredIndices) ---

        /**
         * تحديث محتوى الـ Modal باستخدام الفهرس المفلتر (position in the visible grid)
         * @param {number} filteredIndex - موضع المنتج ضمن القائمة المفلترة حاليًا.
         */
        function updateModalContent(filteredIndex) {
            const indices = JSON.parse(modalMetadata.dataset.filteredIndices || '[]');
            if (filteredIndex < 0 || filteredIndex >= indices.length) return;

            // احصل على الفهرس الأصلي في مصفوفة المنتجات الكاملة
            const originalIndex = indices[filteredIndex]; 
            const product = products[originalIndex];

            // 1. Update Modal Metadata 
            modalMetadata.dataset.isTwoColor = product.isTwoColor || false;
            modalMetadata.dataset.cardIndex = filteredIndex; // CRITICAL: Store filtered index for navigation
            
            // 2. Show/Hide Navigation Arrows
            const showNav = indices.length > 1;
            prevImage.style.display = showNav ? 'flex' : 'none';
            nextImage.style.display = showNav ? 'flex' : 'none';
            
            // 3. Load the Image
            if (product.isTwoColor) {
                // Priority Load for Modal: Black -> White -> Placeholder
                const tryLoadImage = (url, color, finalFallback = false) => {
                    // Reset modal image visibility/state before attempting load
                    modalImage.classList.remove('opacity-50', 'bg-gray-200');
                    modalImage.src = ''; 
                    
                    const tempImg = new Image();
                    tempImg.src = url;

                    tempImg.onload = () => {
                        modalImage.src = url;
                        modalMetadata.dataset.currentColor = color; // Reflect actual color loaded
                    };

                    tempImg.onerror = () => {
                        if (finalFallback) {
                            // Both black and white failed
                            const placeholderText = product.name + ` - غير متاح`;
                            modalImage.src = generatePlaceholder(placeholderText, color);
                            modalImage.classList.add('opacity-50', 'bg-gray-200');
                            modalMetadata.dataset.currentColor = color; // Store the failed color state
                        } else {
                            // Black failed, try white next
                            tryLoadImage(product.whiteImageUrl, 'white', true);
                        }
                    };
                    // Set modal image src to the loading image's src for immediate display if possible
                    modalImage.src = tempImg.src;
                };
                // Start with Black
                tryLoadImage(product.blackImageUrl, 'black', false);
                
            } else {
                // Standard single image load (Mugs, etc.)
                const initialSrc = product.imageUrl;
                modalMetadata.dataset.currentColor = 'N/A';

                const tempImg = new Image();
                tempImg.src = initialSrc;

                tempImg.onload = () => {
                    modalImage.src = initialSrc;
                    modalImage.classList.remove('opacity-50', 'bg-gray-200');
                };

                tempImg.onerror = () => {
                    const placeholderText = product.name + ' - غير متاح';
                    modalImage.src = generatePlaceholder(placeholderText, 'black');
                    modalImage.classList.add('opacity-50', 'bg-gray-200');
                };
                // Set source to trigger load/error handlers
                modalImage.src = initialSrc;
            }
        }
        
        /**
         * التنقل بين المنتجات المعروضة حاليًا في القائمة المفلترة
         * @param {string} direction - 'next-card' أو 'prev-card'
         */
        async function navigateModal(direction) {
            let currentFilteredIndex = parseInt(modalMetadata.dataset.cardIndex);
            const indices = JSON.parse(modalMetadata.dataset.filteredIndices || '[]');
            const totalFilteredProducts = indices.length;
            
            if (isNaN(currentFilteredIndex) || totalFilteredProducts <= 1) {
                return;
            }

            let newFilteredIndex = currentFilteredIndex;

            // Find the next/previous product *within the filtered list*
            do {
                if (direction === 'next-card') {
                    newFilteredIndex = (newFilteredIndex + 1) % totalFilteredProducts;
                } else if (direction === 'prev-card') {
                    newFilteredIndex = (newFilteredIndex - 1 + totalFilteredProducts) % totalFilteredProducts;
                }
                
                // If we wrap around and hit the same index, we stop (safety check)
                if (newFilteredIndex === currentFilteredIndex) {
                    return; 
                }
                
                // Get the actual product data using the original index
                const originalIndex = indices[newFilteredIndex];
                const product = products[originalIndex];

                // Check availability (robustness check)
                if (await isProductImageAvailable(product)) {
                    updateModalContent(newFilteredIndex); // Pass the new filtered index
                    return;
                }
                
            } while (newFilteredIndex !== currentFilteredIndex);
        }
        
        // Event listeners for modal navigation
        prevImage.addEventListener('click', (e) => { e.stopPropagation(); navigateModal('prev-card'); });
        nextImage.addEventListener('click', (e) => { e.stopPropagation(); navigateModal('next-card'); });

        // Keyboard navigation listener (active when modal is open)
        document.addEventListener('keydown', (e) => {
            if (imageModal.classList.contains('flex')) { // Check if modal is open
                if (e.key === 'ArrowLeft') {
                    // For RTL, ArrowLeft (Left physical key) means NEXT ITEM in the list
                    navigateModal('next-card');
                } else if (e.key === 'ArrowRight') {
                    // For RTL, ArrowRight (Right physical key) means PREVIOUS ITEM in the list
                    navigateModal('prev-card');
                } else if (e.key === 'Escape') {
                    hideModal();
                }
            }
        });


        // --- Color Toggle Logic for Hoodie Cards (INTERNAL) ---

        function toggleHoodieColor(card, color) {
            const imgElement = card.querySelector('.product-image');
            const overlay = card.querySelector('.unavailable-overlay'); 
            const blackUrl = card.dataset.blackUrl;
            const whiteUrl = card.dataset.whiteUrl;
            const dots = card.querySelectorAll('.color-dot');
            const isBlack = color === 'black';

            // Determine the new image source
            const newSrc = isBlack ? blackUrl : whiteUrl;
            
            // 1. Hide the overlay and ensure image visibility before attempting to load
            if (overlay) overlay.classList.add('hidden');
            imgElement.style.display = 'block'; 
            
            // 2. **CRITICAL FIX:** Clear existing onerror handler to ensure it re-triggers
            imgElement.onerror = null; 

            // 3. Define the dynamic onerror handler (لضمان ظهور "غير متاح" إذا فشل تحميل أي من الصورتين)
            imgElement.onerror = () => {
                // If loading fails for ANY color, we show the 'غير متاح' overlay
                if (overlay) {
                    imgElement.style.display = 'none'; 
                    overlay.classList.remove('hidden');
                } else {
                    // Fallback to placeholder if overlay is somehow missing (safety net)
                    const productName = card.querySelector('h3').textContent;
                    imgElement.src = generatePlaceholder(productName, color);
                    imgElement.style.display = 'block';
                }
            };
            
            // 4. Define the onload handler to clear any previous error/overlay state
            imgElement.onload = () => {
                // Ensure the onload only resets the overlay if the image actually loaded
                if (overlay) overlay.classList.add('hidden');
                imgElement.style.display = 'block';
            }

            // 5. Update image source (triggers onload or onerror)
            imgElement.src = newSrc;


            // Update active dot
            dots.forEach(dot => dot.classList.remove('active'));
            if (isBlack) {
                dots[0].classList.add('active');
            } else {
                dots[1].classList.add('active');
            }
            card.dataset.currentColor = color;
        }
        
        function setupColorToggleInteractions(card) {
            const imageContainer = card.querySelector('.image-swipe-area');
            
            const dotBlack = card.querySelector('.dot-black');
            const dotWhite = card.querySelector('.dot-white');

            let startX = 0;

            // Desktop Mouse Swipe
            imageContainer.addEventListener('mousedown', (e) => {
                startX = e.clientX;
            });

            imageContainer.addEventListener('mouseup', (e) => {
                const diffX = e.clientX - startX;
                if (Math.abs(diffX) > 40) { // Require a substantial swipe
                    const currentColor = card.dataset.currentColor;
                    const newColor = currentColor === 'black' ? 'white' : 'black';
                    toggleHoodieColor(card, newColor);
                }
            });

            // Mobile Touch Swipe
            imageContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });

            imageContainer.addEventListener('touchend', (e) => { 
                const endX = e.changedTouches[0].clientX;
                const diffX = endX - startX;
                if (Math.abs(diffX) > 40) { // Require a substantial swipe
                    const currentColor = card.dataset.currentColor;
                    const newColor = currentColor === 'black' ? 'white' : 'black';
                    toggleHoodieColor(card, newColor);
                }
            });

            // Dot Click Listeners
            if (dotBlack) dotBlack.onclick = (e) => { e.stopPropagation(); toggleHoodieColor(card, 'black'); };
            if (dotWhite) dotWhite.onclick = (e) => { e.stopPropagation(); toggleHoodieColor(card, 'white'); };

            // Modal click listener (FIXED)
            imageContainer.addEventListener('click', (e) => {
                const imgElement = card.querySelector('.product-image');
                const overlay = card.querySelector('.unavailable-overlay');
                
                // CRITICAL FIX: Find the index of the clicked card *within the currently displayed (filtered) list*
                const filteredIndex = currentlyDisplayedCards.indexOf(card);
                
                if (imgElement.style.display === 'none' && overlay && !overlay.classList.contains('hidden')) {
                     console.log("Image not available for magnification.");
                } else {
                    // Pass the filtered index (position in the current grid) to the modal update function
                    updateModalContent(filteredIndex);
                    
                    imageModal.classList.remove('hidden');
                    imageModal.classList.add('flex');
                }
            });
        }
        

        // --- GENDER FILTER LOGIC ---
        
        function renderGenderFilters() {
            const genders = ['الكل', 'BOYS', 'GIRLS']; 
            genderFiltersContainer.innerHTML = '';

            if (activeFilter === 'هودي') {
                genderFiltersContainer.style.display = 'flex';

                genders.forEach(gender => {
                    const button = document.createElement('button');
                    const buttonText = (gender === 'BOYS' || gender === 'GIRLS') ? gender : 'الكل';
                    button.textContent = buttonText;
                    
                    button.dataset.filterValue = gender; 

                    const isActive = (gender === activeGenderFilter);

                    button.className = `px-4 py-2 rounded-lg font-bold text-lg transition-colors duration-300 border-2 border-red-600 ${
                        isActive
                        ? 'active-filter'
                        : 'bg-white dark:bg-gray-700 text-red-600 dark:text-red-500 hover:bg-red-100 dark:hover:bg-gray-600'
                    }`;
                    
                    button.addEventListener('click', () => {
                        activeGenderFilter = gender;
                        renderProducts(activeFilter);
                        updateActiveGenderButton();
                    });
                    genderFiltersContainer.appendChild(button);
                });
            } else {
                genderFiltersContainer.style.display = 'none';
                activeGenderFilter = 'الكل'; 
            }
        }

        function updateActiveGenderButton() {
            const buttons = genderFiltersContainer.querySelectorAll('button');
            buttons.forEach(button => {
                if(button.dataset.filterValue === activeGenderFilter) {
                    button.classList.add('active-filter');
                    button.classList.remove('bg-white', 'dark:bg-gray-700', 'text-red-600', 'dark:text-red-500', 'hover:bg-red-100', 'dark:hover:bg-gray-600');
                } else {
                    button.classList.remove('active-filter');
                    button.className = 'px-4 py-2 rounded-lg font-bold text-lg transition-colors duration-300 border-2 border-red-600 bg-white dark:bg-gray-700 text-red-600 dark:text-red-500 hover:bg-red-100 dark:hover:bg-gray-600';
                }
            });
        }
        
        // --- Core Rendering Functions (MODIFIED FOR FILTERED NAVIGATION SUPPORT) ---

        // Render product cards
        function renderProducts(filter) {
            productGrid.innerHTML = '';
            const allProductElements = [];
            const filteredIndices = []; // Array to store ORIGINAL indices of displayed products
            
            renderGenderFilters();

            products.forEach((product, index) => {
                // 1. Category Filter Check
                if (product.category !== filter) return;
                
                // 2. Gender Filter Check
                if (product.category === 'هودي' && activeGenderFilter !== 'الكل') {
                    
                    const isGirlProduct = product.gender === 'GIRLS';
                    const isBoyProduct = product.gender === undefined; 

                    if (activeGenderFilter === 'BOYS') {
                        // FIX: Ensure that the original products without 'gender' are displayed for BOYS filter.
                        if (isGirlProduct) return;
                        // If it's a hoodie AND not a GIRLS product, it passes the BOYS filter.
                    } else if (activeGenderFilter === 'GIRLS') {
                        // FIX: Ensure only products explicitly marked 'GIRLS' are displayed.
                        if (isBoyProduct) return;
                        if (!isGirlProduct) return;
                    } 
                } 
                
                // If the product passes all filters, we include it and track its original index
                filteredIndices.push(index);

                const description = categoryDescriptions[product.category] || '';
                let cardHTML;

                if (product.category === 'جاكيت' || product.category === 'توتي باجز') {
                    // Render Coming Soon Card (Text Only)
                    cardHTML = `
                    <div class="product-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-transform duration-300 hover:scale-105 hover:shadow-2xl flex flex-col h-full" data-index="${index}" data-original-index="${index}">
                        <div class="w-full h-64 bg-gray-600 dark:bg-gray-700 flex items-center justify-center">
                            <h3 class="text-3xl font-extrabold text-white tracking-widest">${product.name.toUpperCase()}</h3>
                        </div>
                        <div class="p-5 text-center flex-grow flex flex-col">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold mb-2 truncate">${product.name.toUpperCase()}</h3>
                                <p class="text-sm text-red-600 dark:text-red-500 mb-2 font-semibold">${product.category}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed min-h-[60px]">${description}</p>
                            </div>
                            <div class="text-2xl font-bold text-gray-400 dark:text-gray-500 mt-4">${product.price}</div>
                        </div>
                    </div>`;
                } else if (product.category === 'هودي') {
                    // Render Hoodie Card (Two colors with dots/swipe)
                    const initialImageUrl = product.blackImageUrl; 

                    cardHTML = `
                    <div class="product-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-transform duration-300 hover:scale-105 hover:shadow-2xl flex flex-col" 
                        data-black-url="${product.blackImageUrl}"
                        data-white-url="${product.whiteImageUrl}"
                        data-current-color="black"
                        data-index="${index}"
                        data-original-index="${index}">
                        
                        <div class="image-swipe-area w-full h-64 bg-gray-200 dark:bg-gray-700 cursor-pointer select-none relative">
                            <!-- Image element. src is set here, but the actual display is managed by JS priority check -->
                            <img src="${initialImageUrl}" alt="${product.name}" class="product-image w-full h-full object-cover transition-opacity duration-300">
                            
                            <!-- Overlay for 'Not Available' -->
                            <div class="unavailable-overlay hidden absolute inset-0 w-full h-64 flex items-center justify-center bg-black z-10 transition-opacity duration-300">
                                <span class="text-white text-2xl font-bold p-4 rounded-lg bg-red-600 shadow-lg">غير متاح</span>
                            </div>

                        </div>
                        
                        <div class="flex justify-center gap-3 py-2">
                            <span class="color-dot dot-black active bg-black" title="اللون الأسود"></span>
                            <span class="color-dot dot-white bg-white" title="اللون الأبيض"></span>
                        </div>
                        
                        <div class="p-5 text-center flex-grow flex flex-col">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold mb-2 truncate">${product.name}</h3>
                                <p class="text-sm text-red-600 dark:text-red-500 mb-2 font-semibold">${product.category}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed min-h-[60px]">${description}</p>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-4">${product.price}</div>
                        </div>
                    </div>`;
                } else {
                    // Render standard cards (Mugs, etc. - single image)
                    const imageUrl = product.imageUrl || generatePlaceholder(product.name, 'black');
                    cardHTML = `
                    <div class="product-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-transform duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer flex flex-col" data-image-url="${imageUrl}" data-index="${index}" data-original-index="${index}">
                        <div class="w-full h-64 bg-gray-200 dark:bg-gray-700 pointer-events-none">
                            <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-64 object-cover" onerror="this.src='${generatePlaceholder(product.name, 'black')}'">
                        </div>
                        <div class="p-5 text-center flex-grow flex flex-col">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold mb-2 truncate">${product.name}</h3>
                                <p class="text-sm text-red-600 dark:text-red-500 mb-2 font-semibold">${product.category}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed min-h-[60px]">${description}</p>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-4">${product.price}</div>
                        </div>
                    </div>`;
                }

                allProductElements.push(cardHTML);
            });
            
            // Render all filtered products
            productGrid.innerHTML = allProductElements.join('');

            // CRITICAL STEP: Store the current list of displayed product indices and card elements
            modalMetadata.dataset.filteredIndices = JSON.stringify(filteredIndices);
            currentlyDisplayedCards = Array.from(productGrid.querySelectorAll('.product-card'));
            
            // Attach event listeners after rendering
            currentlyDisplayedCards.forEach((card, filteredIndex) => { // filteredIndex is the position in the current visible list
                const originalIndex = parseInt(card.dataset.index);
                const product = products[originalIndex];

                if (product && product.isTwoColor) {
                    initializeHoodieCard(card);
                } else {
                    // Setup standard modal click listener for other cards (Mugs, etc.)
                    card.addEventListener('click', () => {
                        // Pass the filtered index (position in the current grid)
                        updateModalContent(filteredIndex);
                        
                        imageModal.classList.remove('hidden');
                        imageModal.classList.add('flex');
                    });
                }
            });
        }
        
        // Render category filter buttons (Excluding 'الكل' and setting default active filter)
        function renderCategoryFilters() {
            // استخراج الفئات باستثناء 'الكل'
            const categories = [...new Set(products.map(p => p.category))].filter(cat => cat !== 'الكل');
            
            categoryFiltersContainer.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `px-3 py-2 rounded-md font-semibold transition-colors duration-300 text-sm md:text-base border-2 border-transparent ${
                    activeFilter === category
                    ? 'active-filter'
                    : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600'
                }`;
                
                button.addEventListener('click', () => {
                    const previousFilter = activeFilter;
                    activeFilter = category;
                    
                    // إذا تم تغيير الفئة إلى "هودي" أو العودة منها
                    if (previousFilter !== 'هودي' && activeFilter === 'هودي') {
                        // إعادة تعيين فلتر الجنس إلى "الكل" عند الدخول لفئة الهودي
                        activeGenderFilter = 'الكل';
                    } else if (activeFilter !== 'هودي') {
                        // إخفاء فلاتر الجنس وإعادة تعيينها عند الخروج من فئة الهودي
                        activeGenderFilter = 'الكل'; 
                    }

                    renderProducts(activeFilter);
                    updateActiveButton();
                });
                categoryFiltersContainer.appendChild(button);
            });
        }
        
        // Update the active filter button style (Unchanged)
        function updateActiveButton() {
            const buttons = categoryFiltersContainer.querySelectorAll('button');
            buttons.forEach(button => {
                if(button.textContent === activeFilter) {
                    button.classList.add('active-filter');
                    button.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
                } else {
                    button.classList.remove('active-filter');
                    button.className = 'px-3 py-2 rounded-md font-semibold transition-colors duration-300 text-sm md:text-base border-2 border-transparent bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600';
                }
            });
        }
        
        // Modal close functions (Unchanged)
        const hideModal = () => {
            imageModal.classList.add('hidden');
            imageModal.classList.remove('flex');
        };

        closeModal.addEventListener('click', hideModal);
        imageModal.addEventListener('click', (e) => {
            // Only hide modal if the background (not the content) is clicked
            if (e.target === imageModal || e.target.id === 'imageModalContent') {
                hideModal();
            }
        });


        // Initialize everything on page load
        window.onload = () => {
            // تحديد الفلتر الافتراضي كأول فئة يتم إيجادها (هودي)
            const initialCategories = [...new Set(products.map(p => p.category))].filter(cat => cat !== 'الكل' && cat !== 'جاكيت' && cat !== 'توتي باجز');
            activeFilter = initialCategories[0] || 'هودي'; 

            renderSlideshow();
            renderCategoryFilters();
            
            // يتم عرض المنتجات بناءً على الفلتر الافتراضي الجديد (هودي)
            renderProducts(activeFilter); 
        };
    </script>
</body>
</html>
